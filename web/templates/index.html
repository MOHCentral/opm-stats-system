{{define "content"}}
<div x-data="dashboard()" x-init="init()">
    <!-- Hero Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="stat-card">
            <div class="text-sm text-gray-400 uppercase tracking-wide">Total Kills</div>
            <div class="text-3xl font-bold text-mohaa-sand" x-text="formatNumber(stats.totalKills)">--</div>
            <div class="text-xs text-green-400">+<span x-text="formatNumber(stats.killsToday)">0</span> today</div>
        </div>
        <div class="stat-card">
            <div class="text-sm text-gray-400 uppercase tracking-wide">Active Players</div>
            <div class="text-3xl font-bold text-mohaa-sand" x-text="formatNumber(stats.activePlayers)">--</div>
            <div class="text-xs text-gray-500">Last 7 days</div>
        </div>
        <div class="stat-card">
            <div class="text-sm text-gray-400 uppercase tracking-wide">Matches Played</div>
            <div class="text-3xl font-bold text-mohaa-sand" x-text="formatNumber(stats.totalMatches)">--</div>
            <div class="text-xs text-gray-500">All time</div>
        </div>
        <div class="stat-card">
            <div class="text-sm text-gray-400 uppercase tracking-wide">Live Now</div>
            <div class="text-3xl font-bold text-green-400" x-text="liveMatches.length">0</div>
            <div class="text-xs text-gray-500">Active matches</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Leaderboard -->
        <div class="lg:col-span-1">
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Top Players</h2>
                    <div class="flex space-x-2">
                        <button @click="leaderboardPeriod = 'all'" 
                                :class="leaderboardPeriod === 'all' ? 'bg-mohaa-olive' : 'bg-gray-700'" 
                                class="px-2 py-1 text-xs rounded transition">All</button>
                        <button @click="leaderboardPeriod = 'weekly'" 
                                :class="leaderboardPeriod === 'weekly' ? 'bg-mohaa-olive' : 'bg-gray-700'" 
                                class="px-2 py-1 text-xs rounded transition">Week</button>
                    </div>
                </div>
                <div id="leaderboard-container" 
                     hx-get="/partials/leaderboard" 
                     hx-trigger="load, leaderboardChanged from:body"
                     hx-swap="innerHTML"
                     class="divide-y divide-gray-700">
                    <!-- Skeleton loading -->
                    <template x-for="i in 10">
                        <div class="px-4 py-3 flex items-center space-x-3">
                            <div class="skeleton w-6 h-6 rounded"></div>
                            <div class="flex-1 space-y-2">
                                <div class="skeleton h-4 w-32 rounded"></div>
                                <div class="skeleton h-3 w-20 rounded"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <a href="/leaderboards" class="block px-4 py-3 text-center text-sm text-mohaa-sand hover:bg-gray-700 transition">
                    View Full Leaderboard →
                </a>
            </div>
        </div>

        <!-- Center Column: Charts -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Activity Chart -->
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Activity Over Time</h2>
                    <select x-model="activityRange" @change="updateActivityChart()" 
                            class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
                <div class="h-64">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- Weapon Stats Chart -->
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Popular Weapons</h2>
                    <div class="flex space-x-2">
                        <button @click="weaponChartType = 'bar'" 
                                :class="weaponChartType === 'bar' ? 'bg-mohaa-olive' : 'bg-gray-700'" 
                                class="px-2 py-1 text-xs rounded transition">Bar</button>
                        <button @click="weaponChartType = 'pie'" 
                                :class="weaponChartType === 'pie' ? 'bg-mohaa-olive' : 'bg-gray-700'" 
                                class="px-2 py-1 text-xs rounded transition">Pie</button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="weaponChart"></canvas>
                </div>
            </div>

            <!-- Kill/Death Ratio Distribution -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                    <h3 class="text-md font-semibold mb-4">K/D Distribution</h3>
                    <div class="h-48">
                        <canvas id="kdChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                    <h3 class="text-md font-semibold mb-4">Headshot Rate</h3>
                    <div class="h-48">
                        <canvas id="hsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Matches Section -->
    <div class="mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Live Matches</h2>
            <span class="text-sm text-gray-400" x-text="'Auto-refreshing every 10s'"></span>
        </div>
        <div id="live-matches" 
             hx-get="/partials/live-matches" 
             hx-trigger="load, every 10s"
             hx-swap="innerHTML"
             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Live matches will be loaded here -->
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Recent Matches</h2>
            <a href="/matches" class="text-sm text-mohaa-sand hover:underline">View All →</a>
        </div>
        <div id="recent-matches" 
             hx-get="/partials/recent-matches" 
             hx-trigger="load"
             hx-swap="innerHTML"
             class="space-y-2">
            <!-- Recent matches will be loaded here -->
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        stats: {
            totalKills: 0,
            killsToday: 0,
            activePlayers: 0,
            totalMatches: 0
        },
        liveMatches: [],
        leaderboardPeriod: 'all',
        activityRange: '7d',
        weaponChartType: 'bar',
        charts: {},

        async init() {
            await this.fetchStats();
            this.initCharts();
            
            // Watch for changes
            this.$watch('weaponChartType', () => this.updateWeaponChart());
        },

        async fetchStats() {
            try {
                // In production, fetch from API
                // For now, simulate data
                this.stats = {
                    totalKills: 1547832,
                    killsToday: 4521,
                    activePlayers: 892,
                    totalMatches: 45782
                };
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        },

        formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num?.toString() || '0';
        },

        initCharts() {
            this.initActivityChart();
            this.initWeaponChart();
            this.initKDChart();
            this.initHSChart();
        },

        initActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            const labels = [];
            const kills = [];
            const players = [];
            
            // Generate sample data for last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                kills.push(Math.floor(Math.random() * 5000) + 2000);
                players.push(Math.floor(Math.random() * 200) + 100);
            }

            this.charts.activity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Kills',
                            data: kills,
                            borderColor: '#4a5d23',
                            backgroundColor: 'rgba(74, 93, 35, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Active Players',
                            data: players,
                            borderColor: '#c2b280',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        },

        initWeaponChart() {
            const ctx = document.getElementById('weaponChart');
            if (!ctx) return;

            const weaponData = {
                labels: ['M1 Garand', 'Thompson', 'MP40', 'Kar98k', 'Springfield', 'BAR', 'StG44', 'Grenade'],
                data: [24500, 21200, 19800, 15400, 12100, 9800, 8500, 7200]
            };

            const colors = [
                '#4a5d23', '#5a7d33', '#6a9d43', '#7abd53',
                '#c2b280', '#d2c290', '#e2d2a0', '#8b4513'
            ];

            this.charts.weapon = new Chart(ctx, {
                type: this.weaponChartType === 'pie' ? 'doughnut' : 'bar',
                data: {
                    labels: weaponData.labels,
                    datasets: [{
                        label: 'Kills',
                        data: weaponData.data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: this.weaponChartType === 'pie',
                            position: 'right' 
                        }
                    },
                    scales: this.weaponChartType === 'bar' ? {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    } : {}
                }
            });
        },

        updateWeaponChart() {
            if (this.charts.weapon) {
                this.charts.weapon.destroy();
                this.initWeaponChart();
            }
        },

        initKDChart() {
            const ctx = document.getElementById('kdChart');
            if (!ctx) return;

            // K/D ratio distribution histogram
            const kdRanges = ['<0.5', '0.5-1.0', '1.0-1.5', '1.5-2.0', '2.0-2.5', '2.5-3.0', '>3.0'];
            const playerCounts = [120, 340, 280, 95, 35, 15, 7];

            this.charts.kd = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: kdRanges,
                    datasets: [{
                        label: 'Players',
                        data: playerCounts,
                        backgroundColor: 'rgba(74, 93, 35, 0.8)',
                        borderColor: '#4a5d23',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        },

        initHSChart() {
            const ctx = document.getElementById('hsChart');
            if (!ctx) return;

            // Headshot percentage gauge/radial
            this.charts.hs = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Headshots', 'Body/Other'],
                    datasets: [{
                        data: [23.5, 76.5],
                        backgroundColor: ['#c2b280', 'rgba(75, 85, 99, 0.5)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerX = chart.width / 2;
                        const centerY = chart.height / 2;
                        
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#c2b280';
                        ctx.font = 'bold 24px sans-serif';
                        ctx.fillText('23.5%', centerX, centerY - 8);
                        ctx.font = '12px sans-serif';
                        ctx.fillStyle = '#9ca3af';
                        ctx.fillText('HS Rate', centerX, centerY + 12);
                        ctx.restore();
                    }
                }]
            });
        },

        updateActivityChart() {
            // Would fetch new data based on range
            console.log('Updating activity chart for range:', this.activityRange);
        }
    }
}
</script>
{{end}}
