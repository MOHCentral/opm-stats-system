#!/bin/bash

# OPM Stats System - Unified CLI
# Usage: ./cli <command> [args]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function print_help() {
    echo -e "${BLUE}OPM Stats System CLI${NC}"
    echo ""
    echo "Usage: ./cli <command>"
    echo ""
    echo "Commands:"
    echo "  ${GREEN}test all${NC}       Run all tests (Unit + E2E)"
    echo "  ${GREEN}test unit${NC}      Run Go unit tests (internal packages)"
    echo "  ${GREEN}test e2e${NC}       Run E2E tests (requires running containers)"
    echo "  ${GREEN}test legacy${NC}    Run legacy shell scripts (test_events.sh)"
    echo "  ${GREEN}clean${NC}          Reset and clear ALL data"
    echo "  ${GREEN}view <user>${NC}    View stats for a specific user"
    echo "  ${GREEN}setup [N]${NC}      Create N users (default 1000)"
    echo "  ${GREEN}seed [N]${NC}       Simulate N matches (default 500)"
    echo "  ${GREEN}full-seed${NC}      Run full setup + seed"
    echo "  ${GREEN}seed-tournaments${NC} Create teams and tournaments"
    echo "  ${GREEN}help${NC}           Show this help message"
    echo ""
}

function run_unit_tests() {
    echo -e "\n${BLUE}▶ Running Unit Tests...${NC}"
    # Run tests in all directories EXCEPT tests/ (which are e2e)
    # This finds all packages and filters out the 'tests' package
    go test -v $(go list ./... | grep -v /tests)
}

function run_e2e_tests() {
    echo -e "\n${BLUE}▶ Running End-to-End Tests...${NC}"
    echo -e "${YELLOW}Note: Ensure 'make dev' or 'docker-compose up' is running!${NC}"
    
    # Check if API is up
    if ! curl -s "http://localhost:8080/health" > /dev/null; then
        echo -e "${RED}Error: API is not reachable at http://localhost:8080${NC}"
        echo "Please start the stack with: docker-compose up -d"
        exit 1
    fi

    # Run the tests in the tests/ directory, excluding stress
    go test -v -skip TestStress ./tests/...
}

function run_stress_test() {
    echo -e "\n${BLUE}▶ Running Stress Test...${NC}"
    go test -v -run TestStress ./tests/...
}

function run_legacy_tests() {
    echo -e "\n${BLUE}▶ Running Legacy Shell Tests...${NC}"
    ./test_events.sh quick
    ./test_login.sh
}

case "$1" in
    "test")
        case "$2" in
            "all")
                run_unit_tests
                run_e2e_tests
                ;;
            "unit")
                run_unit_tests
                ;;
            "e2e")
                run_e2e_tests
                ;;
            "stress")
                run_stress_test
                ;;
            "legacy")
                run_legacy_tests
                ;;
            *)
                echo -e "${RED}Unknown test command: $2${NC}"
                print_help
                exit 1
                ;;
        esac
        ;;
    "clean")
        echo -e "\n${RED}⚠ WARNING: This will delete ALL test data!${NC}"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            ./statscli clear
        fi
        ;;
    "view")
        ./statscli view "$2"
        ;;
    "seed-tournaments")
        ./statscli seed-tournaments
        ;;
    "setup")
        ./statscli setup "$2"
        ;;
    "seed")
        ./statscli seed "$2"
        ;;
    "full-seed")
        ./statscli full "$2" "$3"
        ;;
    "help"|"--help"|"-h")
        print_help
        ;;
    *)
        print_help
        exit 1
        ;;
esac
