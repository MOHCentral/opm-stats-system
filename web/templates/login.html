{{define "content"}}
<div x-data="loginPage()" class="max-w-md mx-auto">
    
    <!-- Login Options -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6 mb-6">
        <h1 class="text-2xl font-bold text-center mb-6">Sign In to MOHAA Stats</h1>
        
        <!-- OAuth Providers -->
        <div class="space-y-3">
            <a href="/auth/discord" 
               class="flex items-center justify-center space-x-3 w-full px-4 py-3 bg-[#5865F2] hover:bg-[#4752c4] rounded-lg transition">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z"/>
                </svg>
                <span class="font-medium">Continue with Discord</span>
            </a>
            
            <a href="/auth/steam" 
               class="flex items-center justify-center space-x-3 w-full px-4 py-3 bg-[#171a21] hover:bg-[#2a2f3a] border border-gray-600 rounded-lg transition">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.373 0 0 5.373 0 12c0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.632-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0z"/>
                </svg>
                <span class="font-medium">Continue with Steam</span>
            </a>
        </div>
        
        <div class="relative my-6">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-700"></div>
            </div>
            <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-gray-800 text-gray-400">or</span>
            </div>
        </div>
        
        <p class="text-center text-gray-400 text-sm">
            Sign in to link your game identity, track your stats, and join tournaments.
        </p>
    </div>

    <!-- Game Token Section -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6">
        <h2 class="text-lg font-semibold mb-4">Already signed in? Get your Game Token</h2>
        
        <div x-show="!tokenGenerated" class="space-y-4">
            <p class="text-sm text-gray-400">
                Generate a token to link your in-game identity. Use it with the <code class="bg-gray-700 px-1 rounded">login</code> command in-game.
            </p>
            
            <button @click="generateToken()" 
                    :disabled="generating"
                    class="w-full px-4 py-3 bg-mohaa-olive hover:bg-mohaa-olive/80 rounded-lg font-medium transition disabled:opacity-50">
                <span x-show="!generating">Generate Game Token</span>
                <span x-show="generating" class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Generating...</span>
                </span>
            </button>
        </div>
        
        <div x-show="tokenGenerated" x-cloak class="space-y-4">
            <div class="bg-green-900/30 border border-green-700 rounded-lg p-4">
                <p class="text-sm text-green-400 mb-2">Your game token (valid for 10 minutes):</p>
                <div class="flex items-center space-x-2">
                    <code class="flex-1 bg-gray-900 px-3 py-2 rounded text-lg font-mono tracking-wider" x-text="token"></code>
                    <button @click="copyToken()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-900 rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-2">In-game, open console (~) and type:</p>
                <code class="block bg-gray-800 px-3 py-2 rounded text-mohaa-sand">login <span x-text="token"></span></code>
            </div>
            
            <p class="text-xs text-gray-500 text-center">
                Token expires in <span x-text="expiresIn"></span>
            </p>
        </div>
    </div>

    <!-- Link Identity (for logged in users) -->
    {{if .User}}
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6 mt-6">
        <h2 class="text-lg font-semibold mb-4">Link Game Identity</h2>
        
        <div x-show="!claimCode" class="space-y-4">
            <p class="text-sm text-gray-400">
                Generate a claim code to link your in-game GUID to this account.
            </p>
            
            <button @click="initClaim()" 
                    class="w-full px-4 py-3 bg-mohaa-olive hover:bg-mohaa-olive/80 rounded-lg font-medium transition">
                Generate Claim Code
            </button>
        </div>
        
        <div x-show="claimCode" x-cloak class="space-y-4">
            <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 text-center">
                <p class="text-sm text-blue-400 mb-2">Your claim code:</p>
                <code class="text-3xl font-mono font-bold tracking-widest" x-text="claimCode"></code>
            </div>
            
            <div class="bg-gray-900 rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-2">In-game, open console (~) and type:</p>
                <code class="block bg-gray-800 px-3 py-2 rounded text-mohaa-sand">claim <span x-text="claimCode"></span></code>
            </div>
            
            <p class="text-xs text-gray-500 text-center">
                This will permanently link your game identity to your account.
            </p>
        </div>
        
        <!-- Linked Identities -->
        {{if .User.Identities}}
        <div class="mt-6 pt-6 border-t border-gray-700">
            <h3 class="text-sm font-semibold text-gray-400 mb-3">Linked Identities</h3>
            <div class="space-y-2">
                {{range .User.Identities}}
                <div class="flex items-center justify-between bg-gray-900 rounded px-3 py-2">
                    <div>
                        <span class="font-medium">{{.PlayerName}}</span>
                        <span class="text-xs text-gray-500 ml-2">{{.GUID}}</span>
                    </div>
                    <button class="text-red-400 hover:text-red-300 text-sm">Unlink</button>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
    {{end}}
</div>

<script>
function loginPage() {
    return {
        generating: false,
        tokenGenerated: false,
        token: '',
        expiresIn: '10:00',
        claimCode: null,
        expiryTimer: null,

        async generateToken() {
            this.generating = true;
            try {
                const res = await fetch('/api/v1/auth/device/init', { method: 'POST' });
                const data = await res.json();
                
                this.token = data.user_code;
                this.tokenGenerated = true;
                this.startExpiryTimer(600); // 10 minutes
            } catch (e) {
                console.error('Failed to generate token:', e);
                alert('Failed to generate token. Please try again.');
            }
            this.generating = false;
        },

        startExpiryTimer(seconds) {
            if (this.expiryTimer) clearInterval(this.expiryTimer);
            
            let remaining = seconds;
            this.updateExpiresIn(remaining);
            
            this.expiryTimer = setInterval(() => {
                remaining--;
                this.updateExpiresIn(remaining);
                
                if (remaining <= 0) {
                    clearInterval(this.expiryTimer);
                    this.tokenGenerated = false;
                    this.token = '';
                }
            }, 1000);
        },

        updateExpiresIn(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            this.expiresIn = `${mins}:${secs.toString().padStart(2, '0')}`;
        },

        copyToken() {
            navigator.clipboard.writeText(this.token);
            // Could show a toast notification
        },

        async initClaim() {
            try {
                const res = await fetch('/api/v1/auth/claim/init', { method: 'POST' });
                const data = await res.json();
                this.claimCode = data.code;
            } catch (e) {
                console.error('Failed to init claim:', e);
                alert('Failed to generate claim code.');
            }
        }
    }
}
</script>
{{end}}
