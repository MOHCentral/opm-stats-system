# SPRINT AUDIT REPORT: Stat Corrections

## Overview
Addressed critical data gaps in the "War Room" dashboard and API responses. The following metrics were reported as broken or empty and have been fixed.

## 1. Performance Trend (Last 20 Matches)
**Issue**: Graph was empty. API returned `played_at` as 0 or null.
**Root Cause**: Go `sql.Scan` was trying to read ClickHouse `DateTime64` into a `float64` variable, causing a silent failure.
**Fix**: Updated `GetPlayerStats` and `GetPlayerPerformanceHistory` to scan into `time.Time` and convert to Unix timestamp.
**Status**: ✅ **Verified**. API now returns `[{"matches_played": ..., "played_at": 1769...}]`.

## 2. Hit Distribution (Body Heatmap)
**Issue**: Silhouette / Hit Zones were empty.
**Root Cause**: API was querying for `weapon_hit` events only. The test data contained mostly `kill` events which *do* have hit locations, but were being ignored.
**Fix**: Updated `GetPlayerBodyHeatmap` SQL to include `event_type = 'kill'` and aggregate `hitloc`.
**Status**: ✅ **Verified**. API now returns `{"head": 21, "torso": 77...}`.

## 3. Stance Analysis
**Issue**: Standing/Crouch/Prone kills were all 0.
**Root Cause**: Logic queried for `event_type = 'player_kill'` (invalid) instead of `kill`, and was not utilizing the `actor_stance` column effectively.
**Fix**: Updated `fillStanceStats` to count `actor_stance` values on `kill` events.
**Status**: ✅ **Verified**. Profile now shows `standing_kills: 43`, etc.

## 4. Server Averages (Comparison Widgets)
**Issue**: "Server Avg: 0.0%" for Accuracy/KD.
**Root Cause**: The API endpoint `/stats/global` was not calculating or returning these averages, and the PHP Controller was not passing them to the view.
**Fix**: 
-   **API**: Added aggregate calculations for `server_avg_accuracy` and `server_avg_kd` in `GetGlobalStats`.
-   **PHP**: Updated `MohaaPlayers.php` to inject these values into the dashboard context.
**Status**: ✅ **Verified**. API returns `"server_avg_accuracy": 41.5`.

## 5. Grenade Efficiency
**Issue**: "Grenade Kills" and "Thrown" were 0.
**Root Cause**: The `CombatStats` struct and query logic were completely missing the Grenade-specific fields.
**Fix**: 
-   Expanded `CombatStats` struct.
-   Added SQL logic to `fillCombatStats` to count `grenade_throw` events and kills where weapon matches `Grenade`.
**Status**: ✅ **Verified**. API returns `"grenade_kills": 38, "grenades_thrown": 60`.

## Next Steps for User
-   **Refresh Dashboard**: The fixes are deployed. Refresh the War Room.
-   **Vehicle Stats**: If still 0, ensure `vehicle_enter` events are being generated by the game server (currently 0 in verified profile).
-   **Distance**: The value `450` is correctly calculated (KM). If it seems low/high, adjust the divisor in `player_stats.go` (currently `100000`).
