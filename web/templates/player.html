{{define "content"}}
<div x-data="playerProfile()" x-init="init()">
    <!-- Player Header -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6 mb-6">
        <div class="flex items-start justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-20 h-20 bg-mohaa-olive rounded-lg flex items-center justify-center text-3xl font-bold">
                    {{slice .Player.Name 0 1 | upper}}
                </div>
                <div>
                    <h1 class="text-2xl font-bold">{{.Player.Name}}</h1>
                    <p class="text-gray-400 text-sm">GUID: {{.Player.GUID}}</p>
                    <div class="flex items-center space-x-2 mt-2">
                        {{if .Player.Verified}}
                        <span class="px-2 py-1 bg-green-900/50 text-green-400 text-xs rounded">Verified</span>
                        {{end}}
                        <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded">Rank #{{.Player.Rank}}</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">Last seen</div>
                <div class="text-lg">{{.Player.LastActive | timeAgo}}</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-mohaa-sand">{{.Stats.Kills | formatNumber}}</div>
            <div class="text-xs text-gray-400">Kills</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-red-400">{{.Stats.Deaths | formatNumber}}</div>
            <div class="text-xs text-gray-400">Deaths</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold" :class="stats.kd >= 1 ? 'text-green-400' : 'text-red-400'">
                {{printf "%.2f" .Stats.KDRatio}}
            </div>
            <div class="text-xs text-gray-400">K/D Ratio</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-yellow-400">{{.Stats.Headshots | formatNumber}}</div>
            <div class="text-xs text-gray-400">Headshots</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-mohaa-sand">{{printf "%.1f%%" .Stats.HSPercent}}</div>
            <div class="text-xs text-gray-400">HS Rate</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-mohaa-sand">{{printf "%.1f%%" .Stats.Accuracy}}</div>
            <div class="text-xs text-gray-400">Accuracy</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-mohaa-sand">{{.Stats.Matches | formatNumber}}</div>
            <div class="text-xs text-gray-400">Matches</div>
        </div>
        <div class="stat-card text-center">
            <div class="text-2xl font-bold text-mohaa-sand">{{.Stats.PlaytimeHours}}h</div>
            <div class="text-xs text-gray-400">Playtime</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-700 mb-6">
        <nav class="flex space-x-4">
            <button @click="activeTab = 'overview'"
                :class="activeTab === 'overview' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Overview</button>
            <button @click="activeTab = 'weapons'"
                :class="activeTab === 'weapons' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Weapons</button>
            <button @click="activeTab = 'matches'"
                :class="activeTab === 'matches' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Matches</button>
            <button @click="activeTab = 'heatmaps'"
                :class="activeTab === 'heatmaps' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Map Analysis</button>
            <button @click="activeTab = 'body'"
                :class="activeTab === 'body' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Body Matrix</button>
            <button @click="activeTab = 'achievements'"
                :class="activeTab === 'achievements' ? 'border-mohaa-sand text-white' : 'border-transparent text-gray-400 hover:text-white'"
                class="px-4 py-2 border-b-2 font-medium transition">Achievements</button>
        </nav>
    </div>

    <!-- Tab Content -->

    <!-- Overview Tab -->
    <div x-show="activeTab === 'overview'" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Performance Over Time -->
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Performance Over Time</h3>
            <div class="h-64">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Kill Types -->
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Kill Breakdown</h3>
            <div class="h-64">
                <canvas id="killTypesChart"></canvas>
            </div>
        </div>

        <!-- Top Weapons -->
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Top Weapons</h3>
            <div class="space-y-3">
                {{range $i, $w := .TopWeapons}}
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-gray-500">{{add $i 1}}.</span>
                        <span>{{$w.Name}}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-mohaa-olive h-2 rounded-full" style="width: {{$w.Percentage}}%"></div>
                        </div>
                        <span class="text-sm text-gray-400 w-16 text-right">{{$w.Kills}} kills</span>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Favorite Maps -->
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Favorite Maps</h3>
            <div class="h-64">
                <canvas id="mapsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Weapons Tab -->
    <div x-show="activeTab === 'weapons'" x-cloak>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {{range .WeaponStats}}
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold">{{.Name}}</h4>
                    <span class="text-xs text-gray-400">{{.Category}}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <div class="text-lg font-bold text-mohaa-sand">{{.Kills | formatNumber}}</div>
                        <div class="text-xs text-gray-400">Kills</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-yellow-400">{{.Headshots | formatNumber}}</div>
                        <div class="text-xs text-gray-400">Headshots</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-mohaa-sand">{{printf "%.1f%%" .Accuracy}}</div>
                        <div class="text-xs text-gray-400">Accuracy</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>HS Rate</span>
                        <span>{{printf "%.1f%%" .HSRate}}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: {{.HSRate}}%"></div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Matches Tab -->
    <div x-show="activeTab === 'matches'" x-cloak>
        <div id="match-history" hx-get="/partials/player/{{.Player.GUID}}/matches" hx-trigger="revealed"
            hx-swap="innerHTML" class="space-y-2">
            <!-- Skeleton -->
            <div class="skeleton h-16 rounded-lg"></div>
            <div class="skeleton h-16 rounded-lg"></div>
            <div class="skeleton h-16 rounded-lg"></div>
        </div>
    </div>

    <!-- Heatmaps Tab -->
    <div x-show="activeTab === 'heatmaps'" x-cloak>
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4 mb-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Spatial Analysis</h3>
                <div class="flex space-x-4">
                    <select x-model="heatmapMap" @change="loadHeatmap()"
                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm">
                        <option value="m1l1">Omaha Beach</option>
                        <option value="m2l1">Snowy Park</option>
                        <option value="m3l1">The Hunt</option>
                        <option value="m4l1">Stalingrad</option>
                    </select>
                    <div class="flex space-x-2">
                        <button @click="heatmapType = 'kills'"
                            :class="heatmapType === 'kills' ? 'bg-green-700' : 'bg-gray-700'"
                            class="px-3 py-1 text-sm rounded transition">Kills</button>
                        <button @click="heatmapType = 'deaths'"
                            :class="heatmapType === 'deaths' ? 'bg-red-700' : 'bg-gray-700'"
                            class="px-3 py-1 text-sm rounded transition">Deaths</button>
                    </div>
                </div>
            </div>

            <!-- Heatmap Visualization -->
            <div class="relative aspect-video bg-gray-900 rounded-lg overflow-hidden"
                :style="'background-image: url(/static/maps/' + heatmapMap + '_overview.jpg)'">
                <div id="heatmap-canvas" class="absolute inset-0">
                    <!-- Heatmap points rendered here -->
                    <template x-for="point in heatmapData" :key="point.x + '-' + point.y">
                        <div class="absolute rounded-full transform -translate-x-1/2 -translate-y-1/2 opacity-70"
                            :style="`left: ${point.x}%; top: ${point.y}%; width: ${Math.max(10, point.count * 2)}px; height: ${Math.max(10, point.count * 2)}px; background: ${heatmapType === 'kills' ? 'rgba(74, 255, 100, 0.6)' : 'rgba(255, 74, 100, 0.6)'}`">
                        </div>
                    </template>
                </div>

                <!-- Legend -->
                <div class="absolute bottom-4 right-4 bg-black/80 rounded px-3 py-2 text-xs">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full"
                            :class="heatmapType === 'kills' ? 'bg-green-500' : 'bg-red-500'"></span>
                        <span x-text="heatmapType === 'kills' ? 'Kill Locations' : 'Death Locations'"></span>
                    </div>
                    <div class="text-gray-400 mt-1">
                        <span x-text="heatmapData.length"></span> data points
                    </div>
                </div>
            </div>
        </div>

        <!-- Heatmap Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <h4 class="text-sm text-gray-400 mb-2">Most Active Zone</h4>
                <div class="text-xl font-bold">Sector B-4</div>
                <div class="text-sm text-green-400">32% of kills</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <h4 class="text-sm text-gray-400 mb-2">Danger Zone</h4>
                <div class="text-xl font-bold">MG Nest</div>
                <div class="text-sm text-red-400">28% of deaths</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                <h4 class="text-sm text-gray-400 mb-2">Avg Kill Distance</h4>
                <div class="text-xl font-bold">45.2m</div>
                <div class="text-sm text-gray-400">Per engagement</div>
            </div>
        </div>
    </div>

    <!-- Body Heatmap Tab -->
    <div x-show="activeTab === 'body'" x-cloak>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Visual -->
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6 flex items-center justify-center">
                <div class="relative h-[500px] w-[300px]">
                    <!-- Soldier Silhouette SVG -->
                    <svg viewBox="0 0 200 400" class="w-full h-full drop-shadow-[0_0_15px_rgba(74,222,128,0.2)]">
                        <!-- Head -->
                        <path d="M75,20 Q100,0 125,20 L125,50 Q100,60 75,50 Z" :fill="getBodyColor('head')"
                            stroke="#4a5d23" stroke-width="2" class="transition-colors duration-500" />

                        <!-- Torso -->
                        <path d="M60,60 L140,60 L130,180 L70,180 Z" :fill="getBodyColor('torso')" stroke="#4a5d23"
                            stroke-width="2" class="transition-colors duration-500" />

                        <!-- Left Arm -->
                        <path d="M60,60 L30,150 L50,160 L70,70 Z" :fill="getBodyColor('left_arm')" stroke="#4a5d23"
                            stroke-width="2" class="transition-colors duration-500" />

                        <!-- Right Arm -->
                        <path d="M140,60 L170,150 L150,160 L130,70 Z" :fill="getBodyColor('right_arm')" stroke="#4a5d23"
                            stroke-width="2" class="transition-colors duration-500" />

                        <!-- Left Leg -->
                        <path d="M70,180 L60,300 L90,300 L95,180 Z" :fill="getBodyColor('left_leg')" stroke="#4a5d23"
                            stroke-width="2" class="transition-colors duration-500" />

                        <!-- Right Leg -->
                        <path d="M130,180 L140,300 L110,300 L105,180 Z" :fill="getBodyColor('right_leg')"
                            stroke="#4a5d23" stroke-width="2" class="transition-colors duration-500" />
                    </svg>

                    <!-- Pulsing Hit Indicators -->
                    <div class="absolute inset-x-0 bottom-0 text-center">
                        <p class="text-sm text-gray-400">Updates live based on hit registry</p>
                    </div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="space-y-4">
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-6">
                    <h3 class="text-xl font-bold mb-4 text-mohaa-sand">Hit Distribution</h3>
                    <div class="space-y-4">
                        <template x-for="(hits, part) in bodyStats" :key="part">
                            <div class="flex items-center justify-between">
                                <span class="capitalize text-gray-300" x-text="part.replace('_', ' ')"></span>
                                <div class="flex items-center space-x-3 w-2/3">
                                    <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-1000"
                                            :class="getBarColor(part)" :style="'width: ' + getPercentage(hits) + '%'">
                                        </div>
                                    </div>
                                    <span class="text-sm font-mono w-12 text-right" x-text="hits"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-yellow-900/20 rounded-lg border border-yellow-700/30 p-4">
                    <h4 class="text-yellow-400 font-bold mb-2">Analysis: <span x-text="analyzeWeakness()"></span></h4>
                    <p class="text-sm text-gray-400">
                        High damage intake detected in this region. Recommend adjusting cover usage or stance
                        (crouch/prone) during engagements.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Tab -->
    <div x-show="activeTab === 'achievements'" x-cloak>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {{range .Achievements}}
            <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4 
                        {{if .Unlocked}}border-mohaa-olive{{else}}opacity-50{{end}}">
                <div class="flex items-start space-x-3">
                    <div class="w-12 h-12 bg-gray-700 rounded-lg flex items-center justify-center text-2xl">
                        {{if .Unlocked}}üèÜ{{else}}üîí{{end}}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm">{{.Name}}</h4>
                        <p class="text-xs text-gray-400">{{.Description}}</p>
                        {{if .Unlocked}}
                        <p class="text-xs text-green-400 mt-1">Unlocked {{.UnlockedAt | timeAgo}}</p>
                        {{else if .Progress}}
                        <div class="mt-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Progress</span>
                                <span>{{.Progress}}%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-1">
                                <div class="bg-mohaa-olive h-1 rounded-full" style="width: {{.Progress}}%"></div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
    function playerProfile() {
        return {
            activeTab: 'overview',
            heatmapMap: 'm1l1',
            heatmapType: 'kills',
            heatmapData: [],
            stats: {{.Stats | json }
    },

    init() {
        this.$nextTick(() => {
            if (this.activeTab === 'overview') {
                this.initOverviewCharts();
            }
        });

        this.$watch('activeTab', (tab) => {
            if (tab === 'overview') {
                this.$nextTick(() => this.initOverviewCharts());
            } else if (tab === 'heatmaps') {
                this.loadHeatmap();
            } else if (tab === 'body') {
                this.loadBodyHeatmap();
            }
        });

        this.$watch('heatmapType', () => this.loadHeatmap());
    },

    initOverviewCharts() {
        this.initPerformanceChart();
        this.initKillTypesChart();
        this.initMapsChart();
    },

    initPerformanceChart() {
        const ctx = document.getElementById('performanceChart');
        if (!ctx || ctx.chart) return;

        const labels = [];
        const kills = [];
        const deaths = [];
        for (let i = 13; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            kills.push(Math.floor(Math.random() * 100) + 50);
            deaths.push(Math.floor(Math.random() * 80) + 30);
        }

        ctx.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Kills',
                        data: kills,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Deaths',
                        data: deaths,
                        borderColor: '#f87171',
                        backgroundColor: 'transparent',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(75, 85, 99, 0.3)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    },

    initKillTypesChart() {
        const ctx = document.getElementById('killTypesChart');
        if (!ctx || ctx.chart) return;

        ctx.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Headshots', 'Body', 'Explosives', 'Melee'],
                datasets: [{
                    data: [23, 58, 15, 4],
                    backgroundColor: ['#fbbf24', '#4a5d23', '#f97316', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });
    },

    initMapsChart() {
        const ctx = document.getElementById('mapsChart');
        if (!ctx || ctx.chart) return;

        ctx.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Omaha Beach', 'Snowy Park', 'The Hunt', 'Stalingrad', 'Bridge'],
                datasets: [{
                    label: 'Matches',
                    data: [45, 38, 32, 28, 22],
                    backgroundColor: 'rgba(74, 93, 35, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: 'rgba(75, 85, 99, 0.3)' } },
                    y: { grid: { display: false } }
                }
            }
        });
    },

        async loadHeatmap() {
        const guid = '{{.Player.GUID}}';
        const endpoint = this.heatmapType === 'kills'
            ? `/api/v1/stats/player/${guid}/heatmap/${this.heatmapMap}`
            : `/api/v1/stats/player/${guid}/deaths/${this.heatmapMap}`;

        try {
            const res = await fetch(endpoint);
            const data = await res.json();

            // Normalize positions to percentages for display
            const maxX = Math.max(...data.points.map(p => Math.abs(p.x)));
            const maxY = Math.max(...data.points.map(p => Math.abs(p.y)));

            this.heatmapData = data.points.map(p => ({
                x: ((p.x / maxX) + 1) * 50,
                y: ((p.y / maxY) + 1) * 50,
                count: p.count
            }));
        } catch (e) {
            console.error('Failed to load heatmap:', e);
            // Demo data
            this.heatmapData = Array.from({ length: 30 }, () => ({
                x: Math.random() * 100,
                y: Math.random() * 100,
                count: Math.floor(Math.random() * 10) + 1
            }));
        }
    },

    // Body Heatmap Logic
    bodyStats: { },
    maxBodyHits: 1,

        async loadBodyHeatmap() {
        try {
            const res = await fetch('/api/v1/stats/player/{{.Player.GUID}}/heatmap/body');
            if (!res.ok) throw new Error('Failed to fetch body heatmap');
            this.bodyStats = await res.json();

            // Calculate max for normalization
            this.maxBodyHits = Math.max(...Object.values(this.bodyStats), 1);
        } catch (e) {
            console.error('Body heatmap error:', e);
            // Fallback demo data if API fails
            this.bodyStats = { head: 250, torso: 800, left_arm: 150, right_arm: 180, left_leg: 200, right_leg: 220 };
            this.maxBodyHits = 800;
        }
    },

    getBodyColor(part) {
        const hits = this.bodyStats[part] || 0;
        const intensity = hits / this.maxBodyHits; // 0 to 1

        // Interpolate from Green (low) to Red (high)
        // Green: hsl(120, 50%, 40%) -> Red: hsl(0, 70%, 50%)
        if (intensity < 0.3) return '#4a5d23'; // Base olive
        if (intensity < 0.6) return '#eab308'; // Yellow
        return '#ef4444'; // Red
    },

    getBarColor(part) {
        const hits = this.bodyStats[part] || 0;
        const intensity = hits / this.maxBodyHits;
        if (intensity > 0.6) return 'bg-red-500';
        if (intensity > 0.3) return 'bg-yellow-500';
        return 'bg-mohaa-olive';
    },

    getPercentage(hits) {
        return (hits / this.maxBodyHits) * 100;
    },

    analyzeWeakness() {
        const worstPart = Object.entries(this.bodyStats).reduce((a, b) => a[1] > b[1] ? a : b, ['None', 0])[0];
        return worstPart.replace('_', ' ').toUpperCase();
    }
    }
}
</script>
{{end}}