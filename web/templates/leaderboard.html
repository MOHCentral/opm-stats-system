{{define "content"}}
<div x-data="leaderboards()" x-init="init()">
    <!-- Header with Filters -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold">Leaderboards</h1>
            <p class="text-gray-400">Top players across all stats</p>
        </div>
        
        <div class="flex flex-wrap gap-3">
            <!-- Time Period -->
            <select x-model="period" @change="loadLeaderboard()" 
                    class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                <option value="all">All Time</option>
                <option value="month">This Month</option>
                <option value="week">This Week</option>
                <option value="day">Today</option>
            </select>
            
            <!-- Game Mode -->
            <select x-model="mode" @change="loadLeaderboard()" 
                    class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                <option value="all">All Modes</option>
                <option value="ffa">Free For All</option>
                <option value="tdm">Team Deathmatch</option>
                <option value="obj">Objective</option>
            </select>
            
            <!-- Stat Type -->
            <select x-model="stat" @change="loadLeaderboard()" 
                    class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                <option value="kills">Kills</option>
                <option value="kd">K/D Ratio</option>
                <option value="score">Score</option>
                <option value="headshots">Headshots</option>
                <option value="accuracy">Accuracy</option>
                <option value="playtime">Playtime</option>
                <option value="winrate">Win Rate</option>
            </select>
        </div>
    </div>

    <!-- Quick Stat Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-700/50 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-yellow-400 uppercase tracking-wide">ðŸ¥‡ #1 Player</p>
                    <p class="text-lg font-bold mt-1" x-text="topPlayer?.name || 'Loading...'"></p>
                </div>
                <div class="text-2xl font-bold text-yellow-400" x-text="formatStat(topPlayer?.value, stat)"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <p class="text-xs text-gray-400 uppercase tracking-wide">Total Players</p>
            <p class="text-2xl font-bold text-mohaa-sand" x-text="formatNumber(totalPlayers)"></p>
        </div>
        
        <div class="stat-card">
            <p class="text-xs text-gray-400 uppercase tracking-wide">Average <span x-text="stat"></span></p>
            <p class="text-2xl font-bold text-mohaa-sand" x-text="formatStat(avgValue, stat)"></p>
        </div>
        
        <div class="stat-card relative overflow-hidden">
            <p class="text-xs text-gray-400 uppercase tracking-wide">Your Rank</p>
            <p class="text-2xl font-bold" x-text="userRank ? '#' + userRank : 'N/A'"></p>
            {{if .User}}
            <div class="absolute top-0 right-0 w-8 h-8 bg-mohaa-olive/30 rounded-bl-lg flex items-center justify-center">
                <span class="text-xs">You</span>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Leaderboard Visualization -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Top 3 Podium -->
        <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4 text-center">Top 3</h3>
            <div class="flex items-end justify-center gap-4 h-48">
                <!-- 2nd Place -->
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center text-xl font-bold mb-2">
                        <span x-text="leaderboard[1]?.name?.charAt(0) || '?'"></span>
                    </div>
                    <div class="text-sm font-medium truncate max-w-[80px]" x-text="leaderboard[1]?.name || 'N/A'"></div>
                    <div class="text-xs text-gray-400" x-text="formatStat(leaderboard[1]?.value, stat)"></div>
                    <div class="w-20 h-24 bg-gray-500 rounded-t-lg mt-2 flex items-end justify-center pb-2">
                        <span class="text-2xl">ðŸ¥ˆ</span>
                    </div>
                </div>
                
                <!-- 1st Place -->
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 bg-yellow-600 rounded-full flex items-center justify-center text-2xl font-bold mb-2 ring-4 ring-yellow-400/50">
                        <span x-text="leaderboard[0]?.name?.charAt(0) || '?'"></span>
                    </div>
                    <div class="text-sm font-medium truncate max-w-[80px]" x-text="leaderboard[0]?.name || 'N/A'"></div>
                    <div class="text-xs text-yellow-400" x-text="formatStat(leaderboard[0]?.value, stat)"></div>
                    <div class="w-20 h-32 bg-yellow-600 rounded-t-lg mt-2 flex items-end justify-center pb-2">
                        <span class="text-3xl">ðŸ¥‡</span>
                    </div>
                </div>
                
                <!-- 3rd Place -->
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-amber-700 rounded-full flex items-center justify-center text-xl font-bold mb-2">
                        <span x-text="leaderboard[2]?.name?.charAt(0) || '?'"></span>
                    </div>
                    <div class="text-sm font-medium truncate max-w-[80px]" x-text="leaderboard[2]?.name || 'N/A'"></div>
                    <div class="text-xs text-gray-400" x-text="formatStat(leaderboard[2]?.value, stat)"></div>
                    <div class="w-20 h-16 bg-amber-700 rounded-t-lg mt-2 flex items-end justify-center pb-2">
                        <span class="text-2xl">ðŸ¥‰</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribution Chart -->
        <div class="lg:col-span-2 bg-gray-800/50 rounded-lg border border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Score Distribution</h3>
            <div class="h-48">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Main Leaderboard Table -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-900/50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-16">Rank</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Player</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider" x-text="statLabel(stat)"></th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider hidden md:table-cell">Kills</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider hidden md:table-cell">Deaths</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider hidden lg:table-cell">Matches</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider hidden lg:table-cell">Last Active</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700/50">
                <template x-for="(player, index) in leaderboard" :key="player.guid">
                    <tr class="hover:bg-gray-700/30 transition"
                        :class="{'bg-mohaa-olive/10 ring-1 ring-mohaa-olive/30': player.isUser}">
                        <td class="px-4 py-3">
                            <span class="font-bold" 
                                  :class="{
                                      'text-yellow-400': index === 0,
                                      'text-gray-300': index === 1,
                                      'text-amber-600': index === 2
                                  }"
                                  x-text="'#' + (index + 1)"></span>
                        </td>
                        <td class="px-4 py-3">
                            <a :href="'/player/' + player.guid" class="flex items-center space-x-3 hover:text-mohaa-sand transition">
                                <div class="w-8 h-8 bg-gray-700 rounded flex items-center justify-center text-sm font-bold"
                                     x-text="player.name.charAt(0).toUpperCase()"></div>
                                <div>
                                    <div class="font-medium" x-text="player.name"></div>
                                    <div class="text-xs text-gray-500" x-text="player.country || ''"></div>
                                </div>
                            </a>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="font-bold text-mohaa-sand" x-text="formatStat(player.value, stat)"></span>
                        </td>
                        <td class="px-4 py-3 text-right text-gray-400 hidden md:table-cell" x-text="formatNumber(player.kills)"></td>
                        <td class="px-4 py-3 text-right text-gray-400 hidden md:table-cell" x-text="formatNumber(player.deaths)"></td>
                        <td class="px-4 py-3 text-right text-gray-400 hidden lg:table-cell" x-text="player.matches"></td>
                        <td class="px-4 py-3 text-right text-gray-500 text-sm hidden lg:table-cell" x-text="timeAgo(player.lastActive)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="flex items-center justify-between px-4 py-3 bg-gray-900/50">
            <div class="text-sm text-gray-400">
                Showing <span x-text="(page - 1) * perPage + 1"></span>-<span x-text="Math.min(page * perPage, totalPlayers)"></span> 
                of <span x-text="formatNumber(totalPlayers)"></span>
            </div>
            <div class="flex space-x-2">
                <button @click="prevPage()" :disabled="page === 1"
                        class="px-3 py-1 bg-gray-800 rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <template x-for="p in visiblePages" :key="p">
                    <button @click="goToPage(p)" 
                            :class="p === page ? 'bg-mohaa-olive' : 'bg-gray-800 hover:bg-gray-700'"
                            class="w-8 h-8 rounded transition"
                            x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="page * perPage >= totalPlayers"
                        class="px-3 py-1 bg-gray-800 rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Weapon Leaderboards -->
    <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Weapon Masters</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="weapon in weaponLeaders" :key="weapon.name">
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold" x-text="weapon.name"></h3>
                        <span class="text-xs text-gray-400" x-text="weapon.category"></span>
                    </div>
                    <div class="space-y-2">
                        <template x-for="(player, i) in weapon.topPlayers.slice(0, 3)" :key="player.guid">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center space-x-2">
                                    <span :class="i === 0 ? 'text-yellow-400' : 'text-gray-500'" x-text="'#' + (i + 1)"></span>
                                    <span x-text="player.name"></span>
                                </div>
                                <span class="text-mohaa-sand" x-text="formatNumber(player.kills) + ' kills'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function leaderboards() {
    return {
        period: 'all',
        mode: 'all',
        stat: 'kills',
        page: 1,
        perPage: 25,
        totalPlayers: 0,
        leaderboard: [],
        topPlayer: null,
        avgValue: 0,
        userRank: null,
        weaponLeaders: [],

        get visiblePages() {
            const total = Math.ceil(this.totalPlayers / this.perPage);
            const pages = [];
            const start = Math.max(1, this.page - 2);
            const end = Math.min(total, this.page + 2);
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
        },

        async init() {
            await this.loadLeaderboard();
            await this.loadWeaponLeaders();
            this.$nextTick(() => this.initDistributionChart());
        },

        async loadLeaderboard() {
            try {
                const params = new URLSearchParams({
                    period: this.period,
                    mode: this.mode,
                    stat: this.stat,
                    page: this.page,
                    limit: this.perPage
                });
                
                const res = await fetch(`/api/v1/stats/leaderboard?${params}`);
                const data = await res.json();
                
                this.leaderboard = data.players || [];
                this.totalPlayers = data.total || 0;
                this.topPlayer = this.leaderboard[0];
                this.avgValue = data.average || 0;
                this.userRank = data.userRank;
                
                this.$nextTick(() => this.updateDistributionChart());
            } catch (e) {
                console.error('Failed to load leaderboard:', e);
                // Demo data
                this.leaderboard = this.generateDemoData();
                this.totalPlayers = 1500;
                this.topPlayer = this.leaderboard[0];
            }
        },

        async loadWeaponLeaders() {
            try {
                const res = await fetch('/api/v1/stats/weapon-leaders');
                this.weaponLeaders = await res.json();
            } catch (e) {
                // Demo data
                this.weaponLeaders = [
                    { name: 'M1 Garand', category: 'Rifle', topPlayers: [
                        { guid: '1', name: 'Rifleman', kills: 15420 },
                        { guid: '2', name: 'SharpShot', kills: 12890 },
                        { guid: '3', name: 'Infantry', kills: 11234 }
                    ]},
                    { name: 'Thompson', category: 'SMG', topPlayers: [
                        { guid: '4', name: 'SprayNPray', kills: 18920 },
                        { guid: '5', name: 'CloseQuarters', kills: 16780 },
                        { guid: '6', name: 'Mobster', kills: 14567 }
                    ]},
                    { name: 'Springfield', category: 'Sniper', topPlayers: [
                        { guid: '7', name: 'OneShot', kills: 9870 },
                        { guid: '8', name: 'GhostSniper', kills: 8654 },
                        { guid: '9', name: 'Headhunter', kills: 7890 }
                    ]}
                ];
            }
        },

        generateDemoData() {
            const names = ['Soldier', 'Warrior', 'Fighter', 'Hero', 'Legend', 'Elite', 'Pro', 'Master'];
            return Array.from({length: 25}, (_, i) => ({
                guid: `demo-${i}`,
                name: names[i % names.length] + Math.floor(Math.random() * 1000),
                value: Math.floor(Math.random() * 10000) + (1000 - i * 30),
                kills: Math.floor(Math.random() * 15000),
                deaths: Math.floor(Math.random() * 10000),
                matches: Math.floor(Math.random() * 500),
                lastActive: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString()
            })).sort((a, b) => b.value - a.value);
        },

        initDistributionChart() {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;

            this.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Players',
                        data: [],
                        backgroundColor: 'rgba(74, 93, 35, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(75, 85, 99, 0.3)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
            this.updateDistributionChart();
        },

        updateDistributionChart() {
            if (!this.chart) return;
            
            // Generate distribution buckets
            const buckets = ['0-100', '100-500', '500-1K', '1K-5K', '5K-10K', '10K+'];
            const counts = [150, 450, 380, 320, 140, 60];
            
            this.chart.data.labels = buckets;
            this.chart.data.datasets[0].data = counts;
            this.chart.update();
        },

        statLabel(stat) {
            const labels = {
                kills: 'Kills',
                kd: 'K/D Ratio',
                score: 'Score',
                headshots: 'Headshots',
                accuracy: 'Accuracy',
                playtime: 'Playtime',
                winrate: 'Win Rate'
            };
            return labels[stat] || stat;
        },

        formatStat(value, stat) {
            if (!value) return '0';
            if (stat === 'kd' || stat === 'accuracy' || stat === 'winrate') {
                return typeof value === 'number' ? value.toFixed(2) : value;
            }
            if (stat === 'playtime') {
                return Math.floor(value / 3600) + 'h';
            }
            return this.formatNumber(value);
        },

        formatNumber(n) {
            if (!n) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        },

        timeAgo(date) {
            if (!date) return '';
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        },

        prevPage() { if (this.page > 1) { this.page--; this.loadLeaderboard(); } },
        nextPage() { if (this.page * this.perPage < this.totalPlayers) { this.page++; this.loadLeaderboard(); } },
        goToPage(p) { this.page = p; this.loadLeaderboard(); }
    }
}
</script>
{{end}}
